{% extends "base.html" %}
{% load static %}
{% block title %} Add a new listing! {% endblock title %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/adDetails.css' %}">
{% endblock %}

{% block content %}

<div class="container my-4">
  <div class="row g-4">
    <div class="col-lg-8">

      <div class="mb-3">
        <div class="d-flex gap-2 mt-2 flex-wrap">
          {% if photos %}
            <img
            id="main-img"
            src="{{ photos.0.image.url }}"
            class="gallery-main rounded w-100"
            alt="main photo"
            >
          {% else %}
            <img
            id="main-img"
            src="{% static 'images/defaultImage.jpeg' %}"
            class="gallery-main rounded w-100"
            alt="default photo"
            >
          {% endif %}
        </div>        
        <div class="d-flex gap-2 mt-2 flex-wrap">
          {% if photos %}
            {% for img in photos %}
                <img
                src="{{ img.image.url }}"
                class="gallery-thumb rounded"
                onclick="document.getElementById('main-img').src=this.src;"
                alt="thumb"
                >
              {% endfor %}
              {% else %}
                <img
                  src="{% static 'images/defaultImage.jpeg' %}"
                  class="gallery-thumb rounded"
                  alt="default thumb"
                  >
        {% endif %}
        </div>
      </div>

      <h2 class="fw-bold" href="{% url 'ad_details' ad.pk %}">{{ ad.title }}</h2>
      {% if ad.sold == False %}
        <p class="fs-4 text-success fw-semibold">{{ ad.price }} {{ ad.currency }}</p>
      {% else %}
        <p class="fs-4 text-success fw-semibold">SOLD {{ ad.currency }}</p>
      {% endif %}
      <div class="mb-3">
        {% for tag in ad.tags %}
          <span class="badge text-bg-secondary me-1">{{ tag }}</span>
        {% endfor %}
      </div>

      <h5>Description</h5>
      <p>{{ ad.description|linebreaks }}</p>

      
      <h5>Seller information</h5>
      <ul class="list-unstyled">
        <li>Listed on:<strong> {{ ad.upload_date }}</strong></li>
        <li>Ad ID<strong> {{ ad.pk }}</strong></li>
        <li>Views<strong> {{ ad.views }}</strong></li>
      </ul>

    </div>
    


    
    <div class="col-lg-4">
      {% if user.is_authenticated and user != seller and ad.sold == False  %}
      <div class="card mt-3 mb-3">
        <div class="card-body text-center">
          <!-- Butonul care deschide modalul -->
          <button type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#confirmBuyModal">
            Buy this product
          </button>
      
          <!-- Modalul de confirmare cumpÄƒrare -->
          <div class="modal fade" id="confirmBuyModal" tabindex="-1" aria-labelledby="confirmBuyModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <form method="post" action="{% url 'buy_product' ad.id %}">
                  {% csrf_token %}
                  <div class="modal-header">
                    <h5 class="modal-title" id="confirmBuyModalLabel">Confirm Purchase</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    Are you sure you want to buy <strong>{{ ad.title }}</strong> for <strong>{{ ad.price }} {{ ad.currency }}</strong>?
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Confirm purchase</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      
    {% endif %}
    {% if user.is_authenticated and user != seller and ad.sold == False %}
  <div class="card mb-3">
    <div class="card-body text-center">
      {% if in_wishlist %}
        <button class="btn btn-outline-secondary w-100" disabled>Already in wishlist</button>
      {% else %}
        <form method="post" action="{% url 'add_to_wishlist' ad.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger w-100">Add to wishlist</button>
        </form>
      {% endif %}
    </div>
  </div>
{% endif %}


    
      
      <div class="card mb-3">
        <div class="card-body text-center">
          <a href="{% url 'user_profile' username=ad.user.username %}">{{ ad.user.username }}</a>
          {% if seller.profile_picture %}
          <img src="{{ seller.profile_picture.url }}"
              class="rounded-circle mb-2"
              style="width:96px;height:96px;"
              alt="avatar">
          {% else %}
            <img src=""
                class="rounded-circle mb-2"
                style="width:96px;height:96px;"
                alt="avatar placeholder">
          {% endif %}

          
          {% if seller.phone %}
            <button class="btn btn-outline-primary w-100 phone-btn"
                    onclick="this.innerText='{{ seller.phone }}'; this.classList.remove('btn-outline-primary'); this.classList.add('btn-primary');">
              {{ seller.phone_masked }}show
            </button>
          {% endif %}
        </div>
      </div>

      
      {% comment %} <div class="card">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Location</h6>
          <p class="mb-3">{{ ad.location_text }}</p>
          <div class="map-box rounded overflow-hidden">
            <iframe src="https://maps.google.com/maps?q={{ ad.location_lat }},{{ ad.location_lng }}&hl=en&z=14&output=embed"></iframe>
          </div>
        </div>
      </div> {% endcomment %}

    </div>
  </div>
</div>
{% endblock %}